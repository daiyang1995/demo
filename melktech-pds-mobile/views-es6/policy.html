<!DOCTYPE html>
<html lang="en">
<head>
    <%-include("./commonJs.html")%>
    <%-include("./commonCss.html")%>
    <title>个人订单</title>
    <link rel="stylesheet"  href="<%=localurl%><%=projectUrl%>stylesheets/page/policy.css" />
    <script type="text/babel">
		$(document).ready(function(){
			const shark = new SharkTip({ needShark: true});/*初始化弹窗*/
			const loader = new Loaders({style:"rectangle"});

            /* 回退*/
            $(".header").on("vclick",".backIcon" , function (e) {
               e.preventDefault();
               window.location.href = "<%=localurl%><%=projectUrl%>userCenter";
			});

			$(".bottomTag").on("vclick", "span" ,function (e) {
				e.preventDefault();
				let urlAction = $(this).attr("data-action");
				if(urlAction){
					window.location.href = urlAction;
				}
			});

			$(".bodyContent").on("vclick",".dataList",function (e) {
				e.preventDefault();
				e.stopPropagation();
				let thisJquery = this;
				let epolicyUrl = $(thisJquery).attr("epolicyUrl");
				$("#pdfShow #pdfFrame").attr("src" ,
					"<%=localurl%><%=projectUrl%>generic/web/viewer.html?file="+encodeURIComponent("<%=localurl%><%=projectUrl%>pdf?url="+encodeURIComponent(epolicyUrl)));
				$("#pdfShow").show(400);
			});
			/* 移除pdf展示*/
			/*$(".bodyContent").off("vclick",".dataList");*/
			$("#pdfShow").on("vclick",".backIcon",function (e) {
				$("#pdfShow").hide();
				e.preventDefault();
			});

			/*上拉加载逻辑*/
			/*************** start  ***************/
			var pageIndex = 1;
			function readd() {
				console.log(pageIndex);
				loader.show();
				var formData = new FormData();
				formData.append("pageNum", pageIndex);
				$.ajax({
					url:  "<%=localurl%><%=projectUrl%>getPolicyList",
					type: 'POST',
					data: formData,
					async: true,
					cache: false,
					dataType: 'json',
					contentType: false,
					processData: false,
					success: (data) => {
						if (data.ret == "0") {
							$.each(data.policyList, (idx, obj) => {
								$('.bodyOuterScroller .scroll').append(`
                                    <div class="dataList" data-code="${obj.policyNo}" epolicyUrl="${obj.ePolicyId}">
                                        <div class="ui-grid-a"><span class="ui-block-a">产品名称：</span><span class="ui-block-b">${obj.planName}</span></div>
                                        <div class="ui-grid-a"><span class="ui-block-a">成交日期：</span><span class="ui-block-b">${obj.createTimeStr}</span></div>
                                        <div class="ui-grid-a"><span class="ui-block-a">保费金额：</span><span class="ui-block-b">${obj.fee}</span></div>
                                        <div class="ui-grid-a"><span class="ui-block-a">推广费：</span><span class="ui-block-b">${obj.commision}</span></div>
                                    </div>
                                `);
							});
							$(".bottomTag .count").html(`(${data.count})`);
							$('.bodyOuterScroller').css('max-height',$("body").height()-$(".header").height()-$(".bottomTag").height()+"px" );
							$('.bodyOuterScroller').css('height',$('.bodyOuterScroller .scroll').css('height'));
							if(data.policyList &&  10 > data.policyList.length) {
								if(1 === pageIndex && 0 === data.policyList.length){
									$(".bodyContent").append(`
                                    <div class="noPolicy">
                                        <div class="noPolicyImg">
                                            <img src="<%=localurl%><%=projectUrl%>images/timg.jpg"/>
                                        </div>
                                        <div class="noPolicyStr">你还没有完成过保单</div>
                                    </div>
                                `);
								}
								console.log(data.policyList);
								updownloading.callUpFinish();
							}
							pageIndex++;
						} else {
							shark.show(data.msg);
							setTimeout(function () {
                                window.location.href = "<%=localurl%><%=projectUrl%>login";
							},2000);
							updownloading.callUpFinish();
						}

					},complete: function(data) {
						loader.hide();
					},
					error: (data) => {
						shark.show("系统异常,请联系管理员");
					}
				});
			}
			readd();
			let updownloading = new Updownloading({
				outerScroller: '.bodyOuterScroller',
				scroll: '.scroll',
				downLoadingStatus:false,
				upLoadingStatus:true,
				upFinish:"我也是有底线的",
				downFinish:"向上滑动加载更多",
				resistance:0.7,
				upFunction:readd
			});
			/*************** end  ***************/

		});
    </script>
</head>
<body>
<div class="header">
    <span class="icon-carat-b-onwer backIcon" ></span>
    <span class="title">个人订单</span>
</div>
<div class="bodyContent">
    <div class="bodyOuterScroller">
        <div class = 'scroll'>
        </div>
    </div>

    <div class="bottomTag ui-grid-a" >
        <span class="ui-block-a active">个人订单<span class="count"></span></span>
        <span class="ui-block-b" data-action="<%=localurl%><%=projectUrl%>friendPolicyList" >好友订单</span>
    </div>
</div>

<div id="pdfShow">
    <div class="pdfHeader ">
        <span class="icon-carat-b-onwer backIcon" ></span>
        <span class="pdfTitle ">示例</span>
    </div>
    <iframe id="pdfFrame" ></iframe>
</div>

</body>
</html>